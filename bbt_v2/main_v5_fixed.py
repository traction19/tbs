""" Aplikasi Booking Meeting Room Versi: 5.1 â€“ Fixed Data Display Penulis: kunz Deskripsi: Aplikasi Streamlit untuk melakukan booking ruang meeting dengan tampilan daftar booking berbasis kalender, form input, admin panel, dan validasi lengkap. PERBAIKAN: - Menghapus cache yang menyebabkan data tidak refresh - Menambah force refresh button - Menambah error handling untuk query Supabase """ import streamlit as st import pandas as pd from datetime import datetime, date, time, timedelta import re from supabase import create_client, Client import bcrypt from typing import Tuple import os import uuid from streamlit_calendar import calendar # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 1. KONFIGURASI HALAMAN & CSS # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ st.set_page_config( page_title="Online Booking Meeting Room Warga PnT TSO 19th Floor", page_icon="ğŸ¢", layout="wide", initial_sidebar_state="collapsed", ) def load_css() -> None: """Memuat custom CSS bergaya minimalis Apple-like dengan font Poppins & Inter.""" st.markdown( """ <style> * { font-family: 'Poppins', 'Inter', sans-serif; } body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); } .stApp { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); } .stButton>button { background-color: #1f77b4; color: white; border-radius: 8px; padding: 10px 20px; font-weight: 600; transition: all 0.3s ease; } .stButton>button:hover { background-color: #155a99; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(31, 119, 180, 0.3); } .stTextInput>div>div>input, .stSelectbox>div>div>select, .stTimeInput>div>div>input { border-radius: 8px; border: 2px solid #e0e0e0; padding: 10px; } .stDataFrame { border-radius: 12px; overflow: hidden; } </style> """, unsafe_allow_html=True, ) load_css() # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 2. INISIALISASI SUPABASE (TANPA CACHE) # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ def init_supabase() -> Client | None: """Membuat koneksi Supabase tanpa cache untuk memastikan data selalu fresh.""" try: if "supabase" not in st.secrets: st.error("âš ï¸ Konfigurasi Supabase tidak ditemukan dalam secrets") return None url: str = st.secrets["supabase"]["url"] key: str = st.secrets["supabase"]["key"] if not url.startswith("https://"): st.error("âš ï¸ URL Supabase tidak valid") return None if len(key) < 100: st.error("âš ï¸ API Key Supabase tidak valid") return None supabase: Client = create_client(url, key) # Quick test koneksi supabase.table("bookings19").select("id").limit(1).execute() return supabase except Exception as err: st.error(f"âš ï¸ Gagal terhubung ke Supabase: {err}") return None # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 2.1 FETCH DATA BOOKING DENGAN ERROR HANDLING # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ def fetch_all_bookings(supabase: Client) -> pd.DataFrame: """Mengambil semua data booking dari Supabase dengan error handling.""" try: result = supabase.table("bookings19").select("*").execute() if result.data: df = pd.DataFrame(result.data) # Format kolom tanggal jika ada if 'tanggal_booking' in df.columns: df['tanggal_booking'] = pd.to_datetime(df['tanggal_booking']) return df.sort_values('tanggal_booking', ascending=False) else: st.warning("âš ï¸ Kolom 'tanggal_booking' tidak ditemukan") return pd.DataFrame() else: st.info("ğŸ“‹ Belum ada data booking") return pd.DataFrame() except Exception as e: st.error(f"âŒ Error mengambil data: {str(e)}") return pd.DataFrame() # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 3. VALIDASI INPUT # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ def validate_name(name: str) -> Tuple[bool, str]: if not name or len(name.strip()) < 2: return False, "Nama harus diisi minimal 2 karakter" if not re.match(r"^[A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿\s]+$", name.strip()): return False, "Nama hanya boleh berisi huruf dan spasi" return True, "" def validate_time_range(start_time: time, end_time: time) -> Tuple[bool, str]: if start_time >= end_time: return False, "Waktu selesai harus lebih besar dari waktu mulai" return True, "" def validate_booking_conflict( supabase: Client, booking_date: date, start_time: time, end_time: time, room: str, booking_id: int | None = None, ) -> Tuple[bool, str]: """Cek bentrok jadwal di database.""" try: query = ( supabase.table("bookings19") .select("*") .eq("tanggal_booking", str(booking_date)) .eq("ruang_meeting", room) ) if booking_id: query = query.neq("id", booking_id) result = query.execute() if not result.data: return True, "" for booking in result.data: existing_start = datetime.strptime(booking["waktu_mulai"], "%H:%M:%S").time() existing_end = datetime.strptime(booking["waktu_selesai"], "%H:%M:%S").time() if start_time < existing_end and end_time > existing_start: return ( False, f"Konflik dengan {booking.get('nama', 'N/A')} ({existing_start}-{existing_end})", ) return True, "" except Exception as e: return False, f"Error saat memeriksa konflik jadwal: {str(e)}" # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 4. AUTHENTIKASI ADMIN # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ def admin_authenticated() -> bool: if "admin_authenticated" not in st.session_state: st.session_state.admin_authenticated = False return st.session_state.admin_authenticated def admin_login_page() -> None: st.subheader("ğŸ” Admin Login") col1, col2, _ = st.columns([1, 1, 8]) with col1: if st.button("ğŸ”™ Daftar Booking", use_container_width=True): st.session_state.page = "list" st.rerun() with col2: if st.button("â• Form Booking", use_container_width=True): st.session_state.page = "form" st.rerun() with st.form("admin_login_form"): username = st.text_input("Username") password = st.text_input("Password", type="password") submit = st.form_submit_button("Login") if submit: cfg_admin = st.secrets.get("admin", {}) correct_username = cfg_admin.get("username", "admin") correct_pw_hash = cfg_admin.get("password_hash", "") if ( username == correct_username and bcrypt.checkpw(password.encode(), correct_pw_hash.encode()) ): st.session_state.admin_authenticated = True st.success("Login berhasil!") st.rerun() else: st.error("Username atau password salah") # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 5. HALAMAN FORM BOOKING # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ def booking_form_page(supabase: Client) -> None: st.markdown('<h1 style="text-align: center; color: #1f77b4;">ğŸ“… Form Booking Meeting Room</h1>', unsafe_allow_html=True) col1, col2, _ = st.columns([1, 1, 8]) with col1: if st.button("ğŸ”™ Daftar Booking", use_container_width=True): st.session_state.page = "list" st.rerun() with col2: if st.button("ğŸ” Admin Panel", use_container_width=True): st.session_state.page = "admin" st.rerun() st.markdown("---") col1, col2 = st.columns(2) with col1: nama = st.text_input("ğŸ‘¤ Nama Pemesan", placeholder="Contoh: Kunz Agus") with col2: ruang = st.selectbox( "ğŸ¢ Ruang Meeting", [ "Dedication 1", "Dedication 2", "Dedication 5", "Dedication 6", "Coordination", "Cozy 19.3", "Breakout Traction", "Breakout Dastech", ], ) col1, col2 = st.columns(2) with col1: tanggal = st.date_input("ğŸ“† Tanggal Booking") with col2: keterangan = st.text_area("ğŸ“ Keterangan", placeholder="Contoh: Meeting dengan client") col1, col2 = st.columns(2) with col1: waktu_mulai = st.time_input("â° Waktu Mulai", value=time(9, 0)) with col2: waktu_selesai = st.time_input("â° Waktu Selesai", value=time(10, 0)) st.markdown("---") if st.button("âœ… Simpan Booking", use_container_width=True, type="primary"): is_valid_name, msg_name = validate_name(nama) if not is_valid_name: st.error(f"âŒ {msg_name}") st.stop() is_valid_time, msg_time = validate_time_range(waktu_mulai, waktu_selesai) if not is_valid_time: st.error(f"âŒ {msg_time}") st.stop() is_valid_conflict, msg_conflict = validate_booking_conflict( supabase, tanggal, waktu_mulai, waktu_selesai, ruang ) if not is_valid_conflict: st.error(f"âŒ {msg_conflict}") st.stop() try: new_booking = { "id": str(uuid.uuid4()), "nama": nama.strip(), "ruang_meeting": ruang, "tanggal_booking": str(tanggal), "waktu_mulai": str(waktu_mulai), "waktu_selesai": str(waktu_selesai), "keterangan": keterangan.strip(), } result = supabase.table("bookings19").insert([new_booking]).execute() if result.data: st.success("âœ… Booking berhasil disimpan!") st.balloons() st.session_state.page = "list" st.rerun() else: st.error("âŒ Gagal menyimpan booking") except Exception as e: st.error(f"âŒ Error: {str(e)}") # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 6. HALAMAN DAFTAR BOOKING (DENGAN FORCE REFRESH) # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ def booking_list_page(supabase: Client) -> None: st.markdown('<h1 style="text-align: center; color: #1f77b4;">ğŸ“‹ Daftar Booking</h1>', unsafe_allow_html=True) col1, col2, col3 = st.columns([1, 1, 8]) with col1: if st.button("â• Form Booking", use_container_width=True): st.session_state.page = "form" st.rerun() with col2: if st.button("ğŸ” Admin Panel", use_container_width=True): st.session_state.page = "admin" st.rerun() with col3: if st.button("ğŸ”„ Refresh Data", use_container_width=True): st.rerun() st.markdown("---") # Filter options col1, col2, col3 = st.columns(3) with col1: filter_ruang = st.multiselect( "Filter Ruang Meeting", [ "Dedication 1", "Dedication 2", "Dedication 5", "Dedication 6", "Coordination", "Cozy 19.3", "Breakout Traction", "Breakout Dastech", ], ) with col2: filter_bulan = st.date_input("Filter Bulan", value=date.today()) with col3: sort_order = st.radio("Urutan", ["Terbaru", "Terlama"], horizontal=True) st.markdown("---") # Fetch data df = fetch_all_bookings(supabase) if not df.empty: # Apply filters if filter_ruang: df = df[df['ruang_meeting'].isin(filter_ruang)] if 'tanggal_booking' in df.columns: df = df[df['tanggal_booking'].dt.month == filter_bulan.month] df = df[df['tanggal_booking'].dt.year == filter_bulan.year] # Sort if sort_order == "Terlama": df = df.sort_values('tanggal_booking', ascending=True) # Display with better formatting st.subheader(f"ğŸ“Š Total: {len(df)} booking ditemukan") display_df = df[['id', 'nama', 'ruang_meeting', 'tanggal_booking', 'waktu_mulai', 'waktu_selesai', 'keterangan']].copy() display_df.columns = ['ID', 'Nama', 'Ruang', 'Tanggal', 'Mulai', 'Selesai', 'Keterangan'] st.dataframe(display_df, use_container_width=True, height=400) # Export option if st.button("ğŸ“¥ Export ke CSV"): csv = df.to_csv(index=False) st.download_button( label="Download CSV", data=csv, file_name=f"bookings_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv", mime="text/csv" ) else: st.info("ğŸ“‹ Belum ada data booking. Silakan buat booking baru.") # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 7. HALAMAN ADMIN PANEL (EDIT & DELETE) # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ def admin_panel_page(supabase: Client) -> None: st.markdown('<h1 style="text-align: center; color: #1f77b4;">ğŸ” Admin Panel</h1>', unsafe_allow_html=True) col1, col2, col3 = st.columns([1, 1, 8]) with col1: if st.button("ğŸ“‹ Daftar Booking", use_container_width=True): st.session_state.page = "list" st.rerun() with col2: if st.button("â• Form Booking", use_container_width=True): st.session_state.page = "form" st.rerun() with col3: if st.button("ğŸ”„ Refresh", use_container_width=True): st.rerun() st.markdown("---") if not admin_authenticated(): admin_login_page() else: st.success(f"âœ… Login sebagai Admin") if st.button("ğŸšª Logout", use_container_width=True): st.session_state.admin_authenticated = False st.rerun() st.markdown("---") # Admin functions df = fetch_all_bookings(supabase) if not df.empty: st.subheader("ğŸ“ Edit atau Hapus Booking") selected_booking = st.selectbox( "Pilih Booking", df.apply(lambda row: f"{row['nama']} - {row['tanggal_booking']} ({row['ruang_meeting']})", axis=1), ) booking_index = st.selectbox("", range(len(df)), label_visibility="collapsed") booking = df.iloc[booking_index] st.info(f"Booking ID: {booking['id']}") col1, col2 = st.columns(2) with col1: if st.button("âœï¸ Edit", use_container_width=True): st.session_state.editing_booking = booking['id'] st.rerun() with col2: if st.button("ğŸ—‘ï¸ Hapus", use_container_width=True): try: supabase.table("bookings19").delete().eq("id", booking['id']).execute() st.success("âœ… Booking berhasil dihapus!") st.rerun() except Exception as e: st.error(f"âŒ Error: {str(e)}") else: st.info("ğŸ“‹ Belum ada data booking untuk dikelola") # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ # 8. MAIN APP # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ def main() -> None: # Initialize page state if "page" not in st.session_state: st.session_state.page = "list" # Initialize Supabase supabase = init_supabase() if not supabase: st.stop() # Route pages if st.session_state.page == "form": booking_form_page(supabase) elif st.session_state.page == "admin": admin_panel_page(supabase) else: booking_list_page(supabase) if __name__ == "__main__": main()
